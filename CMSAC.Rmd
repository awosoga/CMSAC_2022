---
title: 'Beyond the Boxscore: Applying Team and Individual Performance Evaluation Metrics to Canadian Basketball'
author: "David Awosoga"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data Sources

Here is the website where I have stored results for public access:
https://canadianbasketballanalytics.carrd.co/#

CEBL Data and Player Information taken from RealGM: https://basketball.realgm.com/international/league/128/Canadian-Elite-Basketball-League

USPORT Data taken from Presto Sports Team Summaries: https://universitysport.prestosports.com/landing/index

USPORT Player Information taken from U Sports Hoops: 
https://usportshoops.ca/mbb2022/index.php

## Team Performance Evaluation Using the Four Factors of Basketball

Here, I performed a multiple linear regression on expected win percentage using the Four Factors of Basketball. A cursory glance at the beta value of each factor for both the men’s and women’s results gives assurance about the model specification. The signs on each coefficient align with a basic understanding of the game of basketball: shooting, rebounding, and free throws will have a positive impact on a team’s success, while turnovers will have a negative effect. The opposite intuitively holds for the opposition and is reflected by the coefficients on the “opp” variables. Each coefficient is statistically significant at the 1% level except for oppFTF in *Model2_Men*, which has a p-value of 0.012.


```{r, echo= TRUE}
# Install and Load Packages 
if (!require("pacman")) install.packages("pacman")
# Use pacman to load add-on packages as desired
pacman::p_load(pacman, caret, lars, tidyverse, rio, scales, tibble, dplyr, stringr, rvest, tidyr, knitr)
oldw <- getOption("warn")
options(warn = -1)

# Set Working Directory to where files are stored
#setwd("~/path/to/CMSAC Files")

## Importing Data with Rio
USPORTS_Men <- import("USPORTS Five Year Four Factors Training Set M.csv")
USPORTS_Women <- import("USPORTS Five Year Four Factors Training Set W.csv")

## Create linear models with and without coefficients to compare fits

Model1_Men <- lm(WinPercentage ~ eFG + TOV + ORB + FTF + oppeFG + oppTOV + oppORB + oppFTF, data = USPORTS_Men)
Model2_Men  <- lm(WinPercentage ~ eFG + TOV + ORB + FTF + oppeFG + oppTOV + oppORB + oppFTF - 1, data = USPORTS_Men)
Model1_Women <- lm(WinPercentage ~ eFG + TOV + ORB + FTF + oppeFG + oppTOV + oppORB + oppFTF, data = USPORTS_Women)
Model2_Women  <- lm(WinPercentage ~ eFG + TOV + ORB + FTF + oppeFG + oppTOV + oppORB + oppFTF - 1, data = USPORTS_Women)

summary(Model1_Men)
summary(Model2_Men)
summary(Model1_Women)
summary(Model2_Women)

```

In *Model1_Men*, the adjusted R^2^ of 0.868 means that the explanatory variables account for nearly 87% of the variation in the response variable (win percentage) of the model. This is extremely high and comparable with results from NBA datasets, providing strong evidence in defence of the factors’ relationship to winning. The minuscule difference between the original and adjusted goodness-of-fit values demonstrates how little penalty each added variable receives. Since the factors and dependent variable can be expressed with percentages, they have a very straightforward interpretation. For example, a 1 percent change in eFG% is expected to change a team’s win percentage by 2.333 percent, and a team that reduces its TOV% by 1 percent is expected to enjoy a 1.962 percent increase in win percentage.

The women’s regression output *Model1_Women* was similar to the men’s model, with intuitively correct coefficients and an excellent R^2^ value of 0.904. The F-statistic was also very high and slightly outperformed the men’s model, giving reason to believe that the four factors may better model the women’s game. *Model2_Women* exhibits a comparable offensive emphasis to *Model2_Men* when estimating the factor coefficients and experiences a large increase in R^2^ with almost zero penalization from the dependent variables. The ability to explain nearly 98% of the model’s variation is substantial and further proves that the four factors are transferable across multiple levels of basketball. It is interesting to note that even though the average eFG% in U SPORTS basketball is vastly different between men and women (48% to 41.3%), the coefficient on these terms for both models is similar.

## Testing The Predictive Power of the Models on 2021-22 Season Data

I tested and compared the relative predictive abilities of the models. Even though the models without intercepts had superior R^2^ values to those with them in the regression output with the training set, they were very similar in predicting win percentage on the test data set. In fact, the models that included the constant term were slightly better, but not by a substantial amount. The men’s and women’s models also produced nearly identical results in explaining the variation of win percentage in the test set.
```{r, echo=FALSE}
#setwd("~/path/to/CMSAC Files")

# Make Predictions!
set.seed(123)
train_women.data <- USPORTS_Women
test_women.data <- import("USPORTS Four Factors Testing Set W.csv")
train_men.data <- USPORTS_Men
test_men.data <- import("USPORTS Four Factors Testing Set M.csv")
Teams <- as.data.frame(read.csv("USPORTS Teams List.csv"))

predictions_women1 <- Model1_Women %>% predict(test_women.data)
predictions_women2 <- Model2_Women %>% predict(test_women.data)
predictions_men1 <- Model1_Men %>% predict(test_men.data)
predictions_men2 <- Model2_Men %>% predict(test_men.data)

## Compare Model Performance on 2021-22 Season Using, R^2, RMSE, and Residual Standard Error (RSE)

errors <- round(as.data.frame(matrix(c(
R2(predictions_men1, test_men.data $ WinPercentage),
RMSE(predictions_men1, test_men.data $ WinPercentage),
sigma(Model1_Men)/mean(test_men.data$WinPercentage),

R2(predictions_men2, test_men.data $ WinPercentage),
RMSE(predictions_men2, test_men.data $ WinPercentage),
sigma(Model2_Men)/mean(test_men.data$WinPercentage),

R2(predictions_women1, test_women.data $ WinPercentage),
RMSE(predictions_women1, test_women.data $ WinPercentage),
sigma(Model1_Women)/mean(test_women.data$WinPercentage),

R2(predictions_women2, test_women.data $ WinPercentage),
RMSE(predictions_women2, test_women.data $ WinPercentage),
sigma(Model2_Women)/mean(test_women.data$WinPercentage)
), ncol = 4)), 3)

colnames(errors) <- c("Model 1 M", "Model 2 M", "Model 1 W", "Model 2 W")
rownames(errors) <- c("R^2", "RMSE", "RSE")
kable(errors, caption = "Comparing Predictive Abilities of Each Model")

```

## Case Studies: Measuring Statistical Accomplishment and Assessing Acheivement Using Residuals

I compared expected and actual win percentages to measure statistical dominance and inferiority and gauge over/underachievement. For the 2021-22 season, the best statistical team on the men's side was the Carleton Ravens and the worst was Grant MacEwan University Griffins. The team that over-achieved the most was the McGill Redbirds, while the most underachieving team last season was the Acadia Axemen. For women, the Saskatchewan Huskies were the most statistically dominant, while the McGill Martlets had the least statistical success. The Trinity Western Spartans were the biggest overachievers, and the Lakehead Thunderwolves were the biggest underachievers.

```{r, echo = FALSE}
pacman::p_load(pacman, caret, lars, tidyverse, rio, scales)
data_mod_men <- data.frame(Predicted = predictions_men1, Observed = test_men.data$WinPercentage, Name = Teams$Name)  # Create data for ggplot2

ggplot(data_mod_men,                                     # Draw plot using ggplot2 package
       aes(x = Predicted, y = Observed, label = Name)) +
  geom_point(color = ifelse(data_mod_men$Name == "Acadia" | data_mod_men$Name == "Carleton" | data_mod_men$Name == "MacEwan" | data_mod_men$Name == "McGill", "black" ,"#f8766d"))+
  geom_abline(intercept = 0,
              slope = 1,
              color = "#00bfc4",
              size = 1) + 
  geom_text(aes(
                label=ifelse(
                  Name == "McGill" | Name == "Acadia" | Name == "Carleton" | Name == "MacEwan",
                  as.character(Name),'')),hjust=0.5, vjust=-0.6) + xlab(
                    "Expected Win Percentage") + 
  ylab("Actual Win Percentage") + 
  scale_x_continuous(labels = percent, breaks = seq(-0.25,1.20,0.25)) + 
  scale_y_continuous(labels = percent) +
  ggtitle("Men") + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5))

data_mod_women <- data.frame(Predicted = predictions_women1, Observed = test_women.data$WinPercentage, Name = Teams$Name)  # Create data for ggplot2
ggplot(data_mod_women,                                     # Draw plot using ggplot2 package
       aes(x = Predicted, y = Observed, label = Name)) +
  geom_point(color = ifelse(data_mod_women$Name == "Lakehead" | data_mod_women$Name == "Saskatchewan" | data_mod_women$Name == "Trinity Western" | data_mod_women$Name == "McGill", "black" ,"#f8766d"))+
  geom_abline(intercept = 0,
              slope = 1,
              color = "#00bfc4",
              size = 1) + 
  geom_text(aes(
                label=ifelse(
                  Name == "Saskatchewan" | Name == "Lakehead" | Name == "Trinity Western" | Name == "McGill",
                  as.character(Name),'')),hjust=0.7, vjust=-1) + xlab(
                    "Expected Win Percentage") + 
  ylab("Actual Win Percentage") + 
  scale_x_continuous(labels = percent, breaks = seq(-0.25,1.20,0.25)) + 
  scale_y_continuous(labels = percent) +
  ggtitle("Women") + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5))


```


## Individual Performance Evaluation using Possession-Based Statistics

Here, I took the following well known basketball analytics and calculated them for the Canadian Elite Basketball League (CEBL).

**The Four Factors of Basketball** were created by current NBA assistant coach Dean Oliver and are derived from the four main ways that a possession can end – a field goal attempt, a turnover, a rebound, and a foul. Their ability to be broken down to individual player performances makes them incredibly important for analysis:

* *Effective Field Goal Percentage (eFG%)* calculates how efficiently a team scores, adjusting for the added value of a 3-pointer. This is the most important factor to a team’s overall success. $eFG =  ((FG+0.5×3P))/FGA$
* *Turnover Percentage (TOV%)* calculates the proportion of a team’s possessions that result in a turnover. This is the second-most important factor. $TOV =  TOV/((FGA +0.44 ×FTA -ORB + TOV))$
* *Offensive Rebound Percentage (ORB%)* is the proportion of offensive rebounds that a team grabs over all available rebounding opportunities. This is omitted from this player evaluation for lack of spatial data on available rebounds per player. This is the third most impactful factor.
* *Free Throw Factor (FTF%)* is the proportion of a team’s field goal attempts that a player converts into free points from the free throw line. It is the final factor worth considering. $FTF =  FT/FGA$

**Player Efficiency Rating (PER)** was created by ESPN analyst Jeff Hollinger as one number that describes a player’s overall value. It takes a players’ boxscore contributions: field goals, free throws, 3’s, assists, rebounds, blocks and steals, turnovers, missed shots, and fouls, adding the positive contributions and penalizing the negative ones using a complex statistical formula that can be found [HERE](https://www.basketball-reference.com/about/per.html). It adjusts for per-minute productivity and team pace, as well as the league averages in all the statistical categories, and is normalized such that a PER of 15 is considered league average. It is biased towards offensive output, so players with an unseen defensive impact will be underrated, but all things considered it gives a digestible look at the value and effectiveness of a player, as well as how well they stack up against their peers.

**Box Plus Minus 2.0 (BPM)** is the successor to PER and has replaced it in most NBA front offices. Created by Daniel Myers, it is much more comprehensive and better-rounded metric than its predecessor (though still a bit offensively biased). BPM estimates a player’s contribution in points above league average per 100 possessions played. It is produced using similar boxscore-based statistics as PER, but also includes a player’s position, offensive role, and their teams’ overall performance in the even more complex calculations. BPM is set such that league average is 0.0 (0 points above or below average). For example, a BPM of 5.0 means that a player’s team is 5 points per 100 possessions better with them on the floor than with average production from another player. It is divided into (O)ffensive BPM and (D)efensive BPM.

**Value Over Replacement Player (VORP)** VORP converts BPM, which doesn’t take playing time into account, into an estimate of a player’s overall contribution to the team. It is measured against what a theoretical bench/replacement player would provide (someone with a BPM of -2.0), by including the number of possessions that a player has featured in and the fractions of their teams’ games that they have played. VORP removes any biases in pace and is the best measure of actual value contributed to a team.

More information on the formulation of BPM and VORP can be found [HERE](https://www.basketball-reference.com/about/bpm2.html) 


```{r echo = FALSE, results='asis'}
#The numbers here will be slightly different than the website because the season is still in progress

yr <- 2022

# Set Global Variables

Positions <- data.frame(2.130, 8.668, -2.486, 0.992, -3.536, 1.667, 50)
colnames(Positions) <- c("Intercept","% of TRB", "% of STL", "% of PF", "% of AST", "% of BLK", "Min Wt")
rownames(Positions) <- "Modern"
OffensiveRole <- data.frame(6, -6.642, -8.544, -0.330)
colnames(OffensiveRole) <- c("Intercept", "% of ast", "% of Threshold", "Pt Threshold")
DefaultPos <- 4

BoxPlusMinusCoefficients <- data.frame(0.860,	-0.560,	-0.246,	0.389,	0.580,	-0.964,	0.613,	0.116,	0.000,	1.369,	1.327,	-0.367)
BoxPlusMinusCoefficients <- rbind(BoxPlusMinusCoefficients, c(0.860,	-0.780,	-0.343,	0.389,	1.034,	-0.964,	0.181,	0.181,	0.000,	1.008,	0.703,	-0.367))
colnames(BoxPlusMinusCoefficients) <- c("Adj. Pt",	"FGA",	"FTA",	"3 Pt FG (bonus)",	"AST",	"TO",	"ORB",	"DRB",	"TRB",	"STL",	"BLK",	"PF")
rownames(BoxPlusMinusCoefficients) <- c("Pos 1", "Pos 5")

OffensiveBoxPlusMinusCoefficients <- data.frame(0.605,	-0.330,	-0.145,	0.477,	0.476,	-0.579,	0.606,	-0.112,	0.000,	0.177,	0.725,	-0.439)
OffensiveBoxPlusMinusCoefficients <- rbind(OffensiveBoxPlusMinusCoefficients, c(0.605,	-0.472,	-0.208,	0.477,	0.476,	-0.882,	0.422,	0.103,	0.000,	0.294,	0.097,	-0.439))
colnames(OffensiveBoxPlusMinusCoefficients) <- c("Adj. Pt",	"FGA",	"FTA",	"3 Pt FG (bonus)",	"AST",	"TO",	"ORB",	"DRB",	"TRB",	"STL",	"BLK",	"PF")
rownames(OffensiveBoxPlusMinusCoefficients) <- c("Pos 1", "Pos 5")

Teams <- c("Niagara River Lions",
"Fraser Valley Bandits",
"Hamilton Honey Badgers",
"Saskatchewan Rattlers",
"Guelph Nighthawks",
"Edmonton Stingers",
"Montreal Alliance",
"Newfoundland Growlers",
"Scarborough Shooting Stars",
"Ottawa Black Jacks")

IDs <- c(1731, 2051, 2049, 2050, 2052, 2053, 1280, 2511, 2510, 2187)
team = matrix(data = c(Teams,IDs), nrow = 10)
if (yr < 2022) {
  team <- team[-which(team[,1] == "Montreal Alliance"),]
  team <- team[-which(team[,1] == "Newfoundland Growlers"),]
  team <- team[-which(team[,1] == "Scarborough Shooting Stars"),]
} 
if (yr < 2020) {
  team <- team[-which(team[,1] == "Ottawa Black Jacks"),]
}
efficiency <- paste0("https://basketball.realgm.com/international/league/128/Canadian-Elite-Basketball-League/team-stats/", yr, "/Advanced_Stats/Team_Totals/team_name/desc")

lgPace <- 0
lgThree <- 0
lgFT <- 0
lgPF   <- 0
lgFTA  <- 0
lgAST  <- 0
lgFG   <- 0
lgPTS  <- 0
lgFGA  <- 0
lgORB  <- 0
lgTO   <- 0
lgTRB  <- 0
lgMin  <- 0
lgBLK  <- 0
lgSTL  <- 0
lgPoss <- 0

lgRankings <- data_frame()
league <- data.frame()
totals <- data.frame()
TeamStats <- data.frame()

#MASSIVE FOR LOOP

for(i in 1:length(team[,1])) {
#Get url page formatted

pos <- str_locate_all(pattern = " ", team[i,1])
urlname <- ""
starting <- (length(pos[[1]])/2) %% 2
for(idx in 1:(((length(pos[[1]])/2))+1)) {
  if(idx == (length(pos[[1]])/2)+1) {
    segment <- substr(team[i,1],starting+1,nchar(team[i,1]))
  } else {
    segment<- paste0(substr(team[i,1],starting-(length(pos[[1]])/2) %% 2,pos[[1]][idx]-1), "-")
}
urlname <- paste0(urlname, segment)
starting <- pos[[1]][idx]
}
for (x in 1:length(urlname)) {
  urlname[x] <-  str_replace_all(urlname[x], "[\\s]", "")
}


gameUrl <- paste0("https://basketball.realgm.com/international/league/128/Canadian-Elite-Basketball-League/team/", team[i,2], "/",urlname, "/stats/", yr,"/Totals/All/All/player/All/desc")
roster <- paste0("https://basketball.realgm.com/international/league/128/Canadian-Elite-Basketball-League/team/", team[i,2], "/",urlname, "/rosters/",yr)
webpage1 <- read_html(gameUrl)
webpage2 <- read_html(roster)
webpage3 <- read_html(efficiency)
shotchart <- "td"
shots_html <- html_nodes(webpage1, shotchart)
roster_html <- html_nodes(webpage2, shotchart)
efficiency_html <- html_nodes(webpage3, shotchart)
shots_data <- html_text(shots_html)
roster_data <- html_text(roster_html)
efficiency_data <- html_text(efficiency_html)

## get rid of some fluff
for (x in 1:length(shots_data)) {
  shots_data[x] <-  str_replace_all(shots_data[x], "[\n\t]", "")
  shots_data[x] <-  str_replace_all(shots_data[x], ",", "")
}

for (x in 1:length(roster_data)) {
  roster_data[x] <-  str_replace_all(roster_data[x], "[\n\t]", "")
}


#Create Totals Table
idx <- which(shots_data == "Team Totals")
playerTotals <- shots_data[1: idx-1]
idx <- which(roster_data == "Starters")
rosterTotals <- roster_data[1:idx-1]

playerSeasonTotals <- data.frame(matrix(unlist(playerTotals), 
                                        nrow = (length(playerTotals)/23), 
                                        byrow = TRUE), stringsAsFactors = FALSE)
playerSeasonTotals <- playerSeasonTotals %>% mutate_at(c(4:23), as.numeric)
colnames(playerSeasonTotals) <- c("Rank", "Name", "Team", "GP", "MIN", 
                                  "PTS", "FGM", "FGA","FG%", "3PM", "3PA", 
                                  "3P%", "FTM", "FTA", "FT%", "OFF", "DEF", 
                                  "TRB", "AST", "STL", "BLK", "TOV", "PF")

playerSeasonTotals <- add_column(playerSeasonTotals, "2PM" = playerSeasonTotals$FGM - playerSeasonTotals$`3PM`, .before = 'FTM')
playerSeasonTotals <- add_column(playerSeasonTotals, "2PA" = playerSeasonTotals$FGA - playerSeasonTotals$`3PA`, .before = 'FTM')
playerSeasonTotals <- add_column(playerSeasonTotals, "2P%" = playerSeasonTotals$`2PM`/playerSeasonTotals$`2PA`, .before = 'FTM')
playerSeasonTotals <- add_column(playerSeasonTotals, "eFG%" = (playerSeasonTotals$FGM + (0.5*playerSeasonTotals$`3PM`))/playerSeasonTotals$FGA, .before = 'FTM')
playerSeasonRoster <- data.frame(matrix(unlist(rosterTotals), nrow = (length(rosterTotals)/9), byrow = TRUE), stringsAsFactors = FALSE)
teamEfficiency <- data.frame(matrix(unlist(efficiency_data), nrow = (length(efficiency_data)/19), byrow = TRUE), stringsAsFactors = FALSE)
teamEfficiency <- teamEfficiency %>%mutate_at(c(3:19), as.numeric)
#colnames(teamEfficiency) <- c("Rank", "Team", "TS%", "eFG%", )

#Get Roster Stats

LeagueAverageORtg <- sum(teamEfficiency$X15, na.rm = TRUE)/length(teamEfficiency$X1)
OffRating <- teamEfficiency$X15[which(teamEfficiency$X2 == team[1])]
DefRating <- teamEfficiency$X16[which(teamEfficiency$X2 == team[1])]
NetRatingAdj <- OffRating - DefRating
Pace <- teamEfficiency$X19[which(teamEfficiency$X2 == team[1])]
OffRatingAdj <- OffRating - LeagueAverageORtg
DefRatingAdj <- DefRating - LeagueAverageORtg
AverageLead <- NetRatingAdj * Pace / 100 / 2
LeadBonus <- 0.35/2*AverageLead
AdjTeamRating <- NetRatingAdj + LeadBonus
AdjOffRating <- OffRatingAdj + LeadBonus/2

#Conglomerate Team Stats
TeamPoints <- sum(playerSeasonTotals$PTS, na.rm = TRUE)
TeamFGA <- sum(playerSeasonTotals$FGA, na.rm = TRUE)
TeamFTA <- sum(playerSeasonTotals$FTA, na.rm = TRUE)
S6 <- ((BoxPlusMinusCoefficients[1,]$FTA/BoxPlusMinusCoefficients[1,]$FGA))
TmPtsPerTSA <- TeamPoints/(TeamFGA+TeamFTA*S6)
BaselinePtsPerTSA <- 1
TotalMinutes <- sum(playerSeasonTotals$MIN, na.rm = TRUE)
TeamTRB <- sum(playerSeasonTotals$TRB, na.rm = TRUE)
TeamSTL <- sum(playerSeasonTotals$STL, na.rm = TRUE)
TeamPF <- sum(playerSeasonTotals$PF, na.rm = TRUE)
TeamAST <- sum(playerSeasonTotals$AST, na.rm = TRUE)
TeamBLK <- sum(playerSeasonTotals$BLK, na.rm = TRUE)
TeamGames <- as.numeric(shots_data[which(shots_data == "Team Totals")+1])

#Gather Data for PER
idx <- which(shots_data == "Team Totals")
last <- idx+20
Statline <- (as.numeric(shots_data[idx :last]))
Statline[1] <- playerSeasonTotals$Team[1]
POSS <- (as.numeric(Statline[20])  + TeamFGA +0.44*TeamFTA-sum(playerSeasonTotals$OFF, na.rm = TRUE))

idx1 <- which(shots_data == "Opponent Totals")
last <- idx1+20
oppStatline <- (as.numeric(shots_data[idx1: last]))
oppPOSS <- (oppStatline[20]+oppStatline[6]+0.44*oppStatline[12]-oppStatline[14])

lgPoss <- lgPoss+POSS
teamPace <- (5*((POSS + oppPOSS)/2) / sum(playerSeasonTotals$MIN, na.rm = TRUE))

lgThree <- lgThree + sum(playerSeasonTotals$`3PM`, na.rm = TRUE)
lgFT <- lgFT + sum(playerSeasonTotals$FTM, na.rm = TRUE)
lgPF   <- lgPF   + sum(playerSeasonTotals$PF, na.rm = TRUE)
lgFTA  <- lgFTA  + TeamFTA  
lgAST  <- lgAST  + TeamAST 
lgFG   <- lgFG   + sum(playerSeasonTotals$FGM, na.rm = TRUE)
lgPTS  <- lgPTS  + TeamPoints  
lgFGA  <- lgFGA  + TeamFGA  
lgORB  <- lgORB  + sum(playerSeasonTotals$OFF, na.rm = TRUE)  
lgTO   <- lgTO   + as.numeric(Statline[20]) 
lgTRB  <- lgTRB  + TeamTRB
lgMin  <- lgMin  + sum(playerSeasonTotals$MIN, na.rm = TRUE)
lgBLK  <- lgBLK  + TeamBLK  
lgSTL  <- lgSTL  + TeamSTL

Statline <- append(Statline, c(POSS, oppPOSS, teamPace))
TeamStats <- rbind(TeamStats, Statline)

#Adjust for Team Shooting Context

playerSeasonTotals <- add_column(playerSeasonTotals, "TSA" = playerSeasonTotals$FGA + S6 * playerSeasonTotals$FTA, .after = 'PF')
playerSeasonTotals <- add_column(playerSeasonTotals, "Pt/TSA" = playerSeasonTotals$PTS/playerSeasonTotals$TSA, .after = 'TSA')
playerSeasonTotals <- add_column(playerSeasonTotals, "Adj. Pts" = ((playerSeasonTotals$`Pt/TSA` - TmPtsPerTSA)+BaselinePtsPerTSA) * playerSeasonTotals$TSA, .after = 'Pt/TSA')
playerSeasonTotals <- add_column(playerSeasonTotals, "Possessions" = playerSeasonTotals$MIN * Pace/40, .after = 'Adj. Pts')


playerSeasonTotals <- add_column(playerSeasonTotals, "ThreshPts" = (playerSeasonTotals$TSA * (playerSeasonTotals$`Pt/TSA`-(TmPtsPerTSA + OffensiveRole$`Pt Threshold`))), .after = 'Possessions')
TeamThreshPts <- sum(playerSeasonTotals$ThreshPts, na.rm = TRUE)

# Calculated Stats per 100 Possessions

playerSeasonTotals <- add_column(playerSeasonTotals, "Adj Pt" = playerSeasonTotals$`Adj. Pts` /playerSeasonTotals$Possessions * 100, .after = 'ThreshPts')
playerSeasonTotals <- add_column(playerSeasonTotals, "FGA_p" = playerSeasonTotals$FGA /playerSeasonTotals$Possessions * 100, .after = 'Adj Pt')
playerSeasonTotals <- add_column(playerSeasonTotals, "FTA_p" = playerSeasonTotals$FTA /playerSeasonTotals$Possessions * 100, .after = 'FGA_p')
playerSeasonTotals <- add_column(playerSeasonTotals, "3PM_p" = playerSeasonTotals$`3PM` /playerSeasonTotals$Possessions * 100, .after = 'FTA_p')
playerSeasonTotals <- add_column(playerSeasonTotals, "AST_p" = playerSeasonTotals$AST /playerSeasonTotals$Possessions * 100, .after = '3PM_p')
playerSeasonTotals <- add_column(playerSeasonTotals, "TOV_p" = playerSeasonTotals$TOV /playerSeasonTotals$Possessions * 100, .after = 'AST_p')
playerSeasonTotals <- add_column(playerSeasonTotals, "ORB_p" = playerSeasonTotals$OFF /playerSeasonTotals$Possessions * 100, .after = 'TOV_p')
playerSeasonTotals <- add_column(playerSeasonTotals, "DRB_p" = playerSeasonTotals$DEF /playerSeasonTotals$Possessions * 100, .after = 'ORB_p')
playerSeasonTotals <- add_column(playerSeasonTotals, "TRB_p" = playerSeasonTotals$TRB /playerSeasonTotals$Possessions * 100, .after = 'DRB_p')
playerSeasonTotals <- add_column(playerSeasonTotals, "STL_p" = playerSeasonTotals$STL /playerSeasonTotals$Possessions * 100, .after = 'TRB_p')
playerSeasonTotals <- add_column(playerSeasonTotals, "BLK_p" = playerSeasonTotals$BLK /playerSeasonTotals$Possessions * 100, .after = 'STL_p')
playerSeasonTotals <- add_column(playerSeasonTotals, "PF_p" = playerSeasonTotals$PF /playerSeasonTotals$Possessions * 100, .after = 'BLK_p')


#% Min

playerSeasonTotals <- add_column(playerSeasonTotals, "% of Min" = playerSeasonTotals$MIN /(TotalMinutes/5), .after = 'PF_p')

# % of Stats

playerSeasonTotals <- add_column(playerSeasonTotals, "% of TRB" = playerSeasonTotals$TRB / TeamTRB / playerSeasonTotals$`% of Min`, .before = '% of Min')
playerSeasonTotals <- add_column(playerSeasonTotals, "% of STL" = playerSeasonTotals$STL / TeamSTL / playerSeasonTotals$`% of Min`, .before = '% of Min')
playerSeasonTotals <- add_column(playerSeasonTotals, "% of PF" = playerSeasonTotals$PF / TeamPF / playerSeasonTotals$`% of Min`, .before = '% of Min')
playerSeasonTotals <- add_column(playerSeasonTotals, "% of AST" = playerSeasonTotals$AST / TeamAST / playerSeasonTotals$`% of Min`, .before = '% of Min')
playerSeasonTotals <- add_column(playerSeasonTotals, "% of BLK" = playerSeasonTotals$BLK / TeamBLK / playerSeasonTotals$`% of Min`, .before = '% of Min')

playerSeasonTotals <- add_column(playerSeasonTotals, "% of ThreshPts" = playerSeasonTotals$ThreshPts / TeamThreshPts / playerSeasonTotals$`% of Min`, .before = '% of Min')

#Estimate Positions
position <- vector()
for(name in playerSeasonTotals$Name) {
  if (name == "Walt Lemon Jr.") {
    name <- "Walt Lemon, Jr."
  }
  if (name == "Derek Cooke Jr.") {
    name <- "Derek Cooke, Jr."
  }
  psn <- playerSeasonRoster$X3[which(name == playerSeasonRoster$X2)]
  if (psn == "-") {
    psn <- "SF"
  }
  convertedNum <- switch(psn, "PG" = 1, "SG" = 2, "SF" = 3, "PF" = 4, "C" = 5, "GF" = 2.5, "FG" = 2.5, "G" = 1.5, "F" = 3.5, "FC" = 4.5)
  position <- append(position,convertedNum)
}
playerSeasonTotals <- add_column(playerSeasonTotals, "Pos Num" = position, .before = '% of Min')
playerSeasonTotals <- add_column(playerSeasonTotals, "Est Pos 1" = Positions$Intercept + 
                                   (playerSeasonTotals$`% of TRB` * Positions$`% of TRB`) + 
                                   (playerSeasonTotals$`% of STL` * Positions$`% of STL`) +
                                   (playerSeasonTotals$`% of PF` * Positions$`% of PF`) + 
                                   (playerSeasonTotals$`% of AST` * Positions$`% of AST`) +
                                   (playerSeasonTotals$`% of BLK` * Positions$`% of BLK`),
                                 .before = '% of Min')

playerSeasonTotals <- add_column(playerSeasonTotals, "Min Adj 1" = (playerSeasonTotals$`Est Pos 1` * playerSeasonTotals$MIN + playerSeasonTotals$`Pos Num` * Positions$`Min Wt`)/(playerSeasonTotals$MIN+Positions$`Min Wt`), .before = '% of Min')

# For loop to get Trim
trim <- vector()
for (num in 1:length(playerSeasonTotals$Rank)) {
  Trim <- max(min(playerSeasonTotals[num,]$`Min Adj 1`,5),1)
 trim <- append(trim, Trim)
}
playerSeasonTotals <- add_column(playerSeasonTotals, "Trim 1" = trim, .before = '% of Min')
#playerSeasonTotals <- add_column(playerSeasonTotals, "Trim 1" = max(min(playerSeasonTotals$`Min Adj 1`,5),1), .before = '% of Min')
playerSeasonTotals <- add_column(playerSeasonTotals, "Tm Avg 1" = sum(playerSeasonTotals$`Trim 1` * playerSeasonTotals$MIN, na.rm = TRUE)/TotalMinutes, .before = '% of Min')
playerSeasonTotals <- add_column(playerSeasonTotals, "Adj Pos 2" = playerSeasonTotals$`Min Adj 1` - (playerSeasonTotals$`Tm Avg 1` - 3), .before = '% of Min')

# For loop to get Trim
trim <- vector()
for (num in 1:length(playerSeasonTotals$Rank)) {
  Trim <- max(min(playerSeasonTotals[num,]$`Adj Pos 2`,5),1)
  trim <- append(trim, Trim)
}
playerSeasonTotals <- add_column(playerSeasonTotals, "Trim 2" = trim, .before = '% of Min')
#playerSeasonTotals <- add_column(playerSeasonTotals, "Trim 2" = max(min(playerSeasonTotals$`Adj Pos 2`,5),1), .before = '% of Min')
playerSeasonTotals <- add_column(playerSeasonTotals, "Tm Avg 2" = sum(playerSeasonTotals$`Trim 2` * playerSeasonTotals$MIN, na.rm = TRUE)/TotalMinutes, .before = '% of Min')
playerSeasonTotals <- add_column(playerSeasonTotals, "Adj Pos 3" = playerSeasonTotals$`Min Adj 1` - (playerSeasonTotals$`Tm Avg 1` - 3) - (playerSeasonTotals$`Tm Avg 2` - 3), .before = '% of Min')

# For loop to get Trim
trim <- vector()
for (num in 1:length(playerSeasonTotals$Rank)) {
  Trim <- max(min(playerSeasonTotals[num,]$`Adj Pos 3`,5),1)
  trim <- append(trim, Trim)
}
playerSeasonTotals <- add_column(playerSeasonTotals, "Trim 3" = trim, .before = '% of Min')
#playerSeasonTotals <- add_column(playerSeasonTotals, "Trim 3" = max(min(playerSeasonTotals$`Adj Pos 3`,5),1), .before = '% of Min')
playerSeasonTotals <- add_column(playerSeasonTotals, "Tm Avg 3" = sum(playerSeasonTotals$`Trim 3` * playerSeasonTotals$MIN, na.rm = TRUE)/TotalMinutes, .before = '% of Min')
playerSeasonTotals <- add_column(playerSeasonTotals, "Adj Pos 4" = playerSeasonTotals$`Min Adj 1` - (playerSeasonTotals$`Tm Avg 1` - 3) - (playerSeasonTotals$`Tm Avg 2` - 3) - (playerSeasonTotals$`Tm Avg 3` - 3), .before = '% of Min')

# For loop to get Position
trim <- vector()
for (num in 1:length(playerSeasonTotals$Rank)) {
  Trim <- max(min(playerSeasonTotals[num,]$`Adj Pos 4`,5),1)
  trim <- append(trim, Trim)
}
playerSeasonTotals <- add_column(playerSeasonTotals, "Position" = trim, .before = '% of Min')
#playerSeasonTotals <- add_column(playerSeasonTotals, "Position" = max(min(playerSeasonTotals$`Adj Pos 4`,5),1), .before = '% of Min')

#Offensive Role

playerSeasonTotals <- add_column(playerSeasonTotals, "Est Off. Role 1" =
                                   OffensiveRole$Intercept + OffensiveRole$`% of ast`*playerSeasonTotals$`% of AST` + 
                                   OffensiveRole$`% of Threshold` * playerSeasonTotals$`% of ThreshPts`, .before = '% of Min')  
playerSeasonTotals <- add_column(playerSeasonTotals, "Min Adj 1_o" =
                                   (playerSeasonTotals$`Est Off. Role` * playerSeasonTotals$MIN + DefaultPos*Positions$`Min Wt`)/(playerSeasonTotals$MIN + Positions$`Min Wt`), .before = '% of Min')
# For loop to get Trim
trim <- vector()
for (num in 1:length(playerSeasonTotals$Rank)) {
  Trim <- max(min(playerSeasonTotals[num,]$`Min Adj 1_o`,5),1)
  trim <- append(trim, Trim)
}
playerSeasonTotals <- add_column(playerSeasonTotals, "Trim 1_o" = trim, .before = '% of Min')

#playerSeasonTotals <- add_column(playerSeasonTotals, "Trim 1_o" = max(min(playerSeasonTotals$`Min Adj 1_o`,5),1), .before = '% of Min')
playerSeasonTotals <- add_column(playerSeasonTotals, "Tm Avg 1_o" = sum(playerSeasonTotals$`Trim 1_o` * playerSeasonTotals$MIN, na.rm = TRUE)/TotalMinutes, .before = '% of Min')
playerSeasonTotals <- add_column(playerSeasonTotals, "Adj Off. Role 2" = playerSeasonTotals$`Min Adj 1_o` - (playerSeasonTotals$`Tm Avg 1_o` - 3), .before = '% of Min')
# For loop to get Trim
trim <- vector()
for (num in 1:length(playerSeasonTotals$Rank)) {
  Trim <- max(min(playerSeasonTotals[num,]$`Adj Off. Role 2`,5),1)
  trim <- append(trim, Trim)
}
playerSeasonTotals <- add_column(playerSeasonTotals, "Trim 2_o" = trim, .before = '% of Min')
#playerSeasonTotals <- add_column(playerSeasonTotals, "Trim 2_o" = max(min(playerSeasonTotals$`Adj Off. Role 2`,5),1), .before = '% of Min')
playerSeasonTotals <- add_column(playerSeasonTotals, "Tm Avg 2_o" = sum(playerSeasonTotals$`Trim 2_o` * playerSeasonTotals$MIN, na.rm = TRUE)/TotalMinutes, .before = '% of Min')
playerSeasonTotals <- add_column(playerSeasonTotals, "Adj Off. Role 3" = playerSeasonTotals$`Min Adj 1_o` - (playerSeasonTotals$`Tm Avg 1_o` - 3) - (playerSeasonTotals$`Tm Avg 2_o` - 3), .before = '% of Min')

# For loop to get Trim
trim <- vector()
for (num in 1:length(playerSeasonTotals$Rank)) {
  Trim <- max(min(playerSeasonTotals[num,]$`Adj Off. Role 3`,5),1)
  trim <- append(trim, Trim)
}
playerSeasonTotals <- add_column(playerSeasonTotals, "Trim 3_o" = trim, .before = '% of Min')
#playerSeasonTotals <- add_column(playerSeasonTotals, "Trim 3_o" = max(min(playerSeasonTotals$`Adj Off. Role 3`,5),1), .before = '% of Min')
playerSeasonTotals <- add_column(playerSeasonTotals, "Tm Avg 3_o" = sum(playerSeasonTotals$`Trim 3_o` * playerSeasonTotals$MIN, na.rm = TRUE)/TotalMinutes, .before = '% of Min')
playerSeasonTotals <- add_column(playerSeasonTotals, "Adj Off. Role 4" = playerSeasonTotals$`Min Adj 1_o` - (playerSeasonTotals$`Tm Avg 1_o` - 3) - (playerSeasonTotals$`Tm Avg 2_o` - 3) - (playerSeasonTotals$`Tm Avg 3_o` - 3), .before = '% of Min')
# For loop to get Offensive Role
trim <- vector()
for (num in 1:length(playerSeasonTotals$Rank)) {
  Trim <- max(min(playerSeasonTotals[num,]$`Adj Off. Role 4`,5),1)
  trim <- append(trim, Trim)
}
playerSeasonTotals <- add_column(playerSeasonTotals, "Offensive Role" = trim, .before = '% of Min')
#playerSeasonTotals <- add_column(playerSeasonTotals, "Offensive Role" = max(min(playerSeasonTotals$`Adj Off. Role 4`,5),1), .before = '% of Min')

# BPM Coefficients to use, based on positions

playerSeasonTotals <- add_column(playerSeasonTotals, "Adj. Pt" = (5 - playerSeasonTotals$Position)/4*BoxPlusMinusCoefficients$`Adj. Pt`[1] + (playerSeasonTotals$Position -1) / 4*BoxPlusMinusCoefficients$`Adj. Pt`[2], .before = '% of Min') 
playerSeasonTotals <- add_column(playerSeasonTotals, "FGA_bpm" = (5 - playerSeasonTotals$`Offensive Role`)/4*BoxPlusMinusCoefficients$FGA[1] + (playerSeasonTotals$`Offensive Role` -1) / 4*BoxPlusMinusCoefficients$FGA[2], .before = '% of Min') 
playerSeasonTotals <- add_column(playerSeasonTotals, "FTA_bpm" = (5 - playerSeasonTotals$`Offensive Role`)/4*BoxPlusMinusCoefficients$FTA[1] + (playerSeasonTotals$`Offensive Role` -1) / 4*BoxPlusMinusCoefficients$FTA[2], .before = '% of Min') 
#playerSeasonTotals <- add_column(playerSeasonTotals, "3PM_bpm" = (5 - playerSeasonTotals$Position)/4*BoxPlusMinusCoefficients$`3 Pt FG (bonus)`[1] + (playerSeasonTotals$Position -1) / 4*BoxPlusMinusCoefficients$`3 Pt FG (bonus)`[2], .before = '% of Min') 

it <- 4
colname <- vector()
for (coef in BoxPlusMinusCoefficients[4:12]) {
colname <- append(colname,paste0(colnames(BoxPlusMinusCoefficients[it]), "_bpm"))
playerSeasonTotals <- add_column(playerSeasonTotals, colname = (5 - playerSeasonTotals$Position)/4*coef[1] + (playerSeasonTotals$Position -1) / 4*coef[2], .before = '% of Min') 
it <- it+1
}
#Rename the columns 
colnames(playerSeasonTotals)[c(79:87)] <- colname

# Raw BPM Calculation
PositionConstantBPM <- c((-0.409*2),0,0,1.387)
PositionConstantOffensive <- c((-0.849*2),0,0,0.43)

playerSeasonTotals <- add_column(playerSeasonTotals, "Scoring" =
                                   (playerSeasonTotals$`Adj Pt` * playerSeasonTotals$`Adj. Pt` )+ 
                                   (playerSeasonTotals$FGA_p * playerSeasonTotals$FGA_bpm ) +
                                   (playerSeasonTotals$FTA_p * playerSeasonTotals$FTA_bpm )+ 
                                   (playerSeasonTotals$`3PM_p` * playerSeasonTotals$`3 Pt FG (bonus)_bpm` ),
                                 .before = '% of Min')

playerSeasonTotals <- add_column(playerSeasonTotals, "Ballhandling" =
                                   (playerSeasonTotals$AST_p * playerSeasonTotals$AST_bpm )+ 
                                   (playerSeasonTotals$TOV_p * playerSeasonTotals$TO_bpm ), .before = '% of Min')

playerSeasonTotals <- add_column(playerSeasonTotals, "Rebounding" =
                                   (playerSeasonTotals$ORB_p * playerSeasonTotals$ORB_bpm )+ 
                                   (playerSeasonTotals$DRB_p * playerSeasonTotals$DRB_bpm ) +
                                   (playerSeasonTotals$TRB_p * playerSeasonTotals$TRB_bpm ), .before = '% of Min')

playerSeasonTotals <- add_column(playerSeasonTotals, "Defense" =
                                   (playerSeasonTotals$STL_p * playerSeasonTotals$STL_bpm )+ 
                                   (playerSeasonTotals$BLK_p * playerSeasonTotals$BLK_bpm ) +
                                   (playerSeasonTotals$PF_p * playerSeasonTotals$PF_bpm ), .before = '% of Min')


pConst <- vector()
for (num in 1:length(playerSeasonTotals$Rank)) {
  if (playerSeasonTotals[num,]$Position < 3) {
    PosConst <- (playerSeasonTotals[num,]$Position - 1) / 2*PositionConstantBPM[2]+(3-playerSeasonTotals[num,]$Position )/2*PositionConstantBPM[1]
  } else {
    PosConst <- (playerSeasonTotals[num,]$Position - 3)/2*PositionConstantBPM[3]+(5-playerSeasonTotals[num,]$Position)/2*PositionConstantBPM[2]
  }
  PosConst <- PosConst + PositionConstantBPM[4] * (playerSeasonTotals[num,]$`Offensive Role`-3)
  pConst <- append(pConst,PosConst)
}
playerSeasonTotals <- add_column(playerSeasonTotals, "Pos Const" = pConst, .before = '% of Min')

RawBPM <- vector()
for (num in 1:length(playerSeasonTotals$Rank)) {
  RawBPM <- append(RawBPM, (playerSeasonTotals[num,]$Scoring + 
                              playerSeasonTotals[num,]$Ballhandling 
                            + playerSeasonTotals[num,]$Rebounding
                            + playerSeasonTotals[num,]$Defense
                            + playerSeasonTotals[num,]$`Pos Const`))
}
playerSeasonTotals <- add_column(playerSeasonTotals, "Raw BPM" = RawBPM, .before = '% of Min')

                                
playerSeasonTotals <- add_column(playerSeasonTotals, "Contributions" = playerSeasonTotals$`Raw BPM`*playerSeasonTotals$`% of Min`, .before = '% of Min') 

Sum <- sum(playerSeasonTotals$Contributions, na.rm = TRUE)
Tm_Adj <- (AdjTeamRating-Sum)/5


#OBPM Coefficients to use, based on Positions:
OffensiveBoxPlusMinusCoefficients
playerSeasonTotals <- add_column(playerSeasonTotals, "Adj. Pt_obpm" = (5 - playerSeasonTotals$Position)/4*OffensiveBoxPlusMinusCoefficients$`Adj. Pt`[1] + (playerSeasonTotals$Position -1) / 4*OffensiveBoxPlusMinusCoefficients$`Adj. Pt`[2], .before = '% of Min') 
playerSeasonTotals <- add_column(playerSeasonTotals, "FGA_obpm" = (5 - playerSeasonTotals$`Offensive Role`)/4*OffensiveBoxPlusMinusCoefficients$FGA[1] + (playerSeasonTotals$`Offensive Role` -1) / 4*OffensiveBoxPlusMinusCoefficients$FGA[2], .before = '% of Min') 
playerSeasonTotals <- add_column(playerSeasonTotals, "FTA_obpm" = (5 - playerSeasonTotals$`Offensive Role`)/4*OffensiveBoxPlusMinusCoefficients$FTA[1] + (playerSeasonTotals$`Offensive Role` -1) / 4*OffensiveBoxPlusMinusCoefficients$FTA[2], .before = '% of Min') 


it <- 4
colname <- vector()
for (coef in OffensiveBoxPlusMinusCoefficients[4:12]) {
  colname <- append(colname,paste0(colnames(OffensiveBoxPlusMinusCoefficients[it]), "_obpm"))
  playerSeasonTotals <- add_column(playerSeasonTotals, colname = (5 - playerSeasonTotals$Position)/4*coef[1] + (playerSeasonTotals$Position -1) / 4*coef[2], .before = '% of Min') 
  it <- it+1
}


#Rename the columns 
colnames(playerSeasonTotals)[c(98:106)] <- colname

PositionConstantOffensive <- c((-0.849*2),0,0,0.43)

playerSeasonTotals <- add_column(playerSeasonTotals, "Scoring_o" =
                                   (playerSeasonTotals$`Adj Pt` * playerSeasonTotals$`Adj. Pt_obpm` )+ 
                                   (playerSeasonTotals$FGA_p * playerSeasonTotals$FGA_obpm ) +
                                   (playerSeasonTotals$FTA_p * playerSeasonTotals$FTA_obpm )+ 
                                   (playerSeasonTotals$`3PM_p` * playerSeasonTotals$`3 Pt FG (bonus)_obpm` ),
                                 .before = '% of Min')

playerSeasonTotals <- add_column(playerSeasonTotals, "Ballhandling_o" =
                                   (playerSeasonTotals$AST_p * playerSeasonTotals$AST_obpm )+ 
                                   (playerSeasonTotals$TOV_p * playerSeasonTotals$TO_obpm ), .before = '% of Min')

playerSeasonTotals <- add_column(playerSeasonTotals, "Rebounding_o" =
                                   (playerSeasonTotals$ORB_p * playerSeasonTotals$ORB_obpm )+ 
                                   (playerSeasonTotals$DRB_p * playerSeasonTotals$DRB_obpm ) +
                                   (playerSeasonTotals$TRB_p * playerSeasonTotals$TRB_obpm ), .before = '% of Min')

playerSeasonTotals <- add_column(playerSeasonTotals, "Defense_o" =
                                   (playerSeasonTotals$STL_p * playerSeasonTotals$STL_obpm )+ 
                                   (playerSeasonTotals$BLK_p * playerSeasonTotals$BLK_obpm ) +
                                   (playerSeasonTotals$PF_p * playerSeasonTotals$PF_obpm ), .before = '% of Min')


pConst <- vector()
for (num in 1:length(playerSeasonTotals$Rank)) {
  if (playerSeasonTotals[num,]$Position < 3) {
    PosConst <- (playerSeasonTotals[num,]$Position - 1) / 2*PositionConstantOffensive[2]+(3-playerSeasonTotals[num,]$Position )/2*PositionConstantOffensive[1]
  } else {
    PosConst <- (playerSeasonTotals[num,]$Position - 3)/2*PositionConstantOffensive[3]+(5-playerSeasonTotals[num,]$Position)/2*PositionConstantOffensive[2]
  }
  PosConst <- PosConst + PositionConstantOffensive[4] * (playerSeasonTotals[num,]$`Offensive Role`-3)
  pConst <- append(pConst,PosConst)
}
playerSeasonTotals <- add_column(playerSeasonTotals, "Pos Const_obpm" = pConst, .before = '% of Min')

RawOBPM <- vector()
for (num in 1:length(playerSeasonTotals$Rank)) {
  RawOBPM <- append(RawOBPM, (playerSeasonTotals[num,]$Scoring_o + 
                              playerSeasonTotals[num,]$Ballhandling_o 
                            + playerSeasonTotals[num,]$Rebounding_o
                            + playerSeasonTotals[num,]$Defense_o
                            + playerSeasonTotals[num,]$`Pos Const_obpm`))
}
playerSeasonTotals <- add_column(playerSeasonTotals, "Raw OBPM" = RawOBPM, .before = '% of Min')


playerSeasonTotals <- add_column(playerSeasonTotals, "Contrib" = playerSeasonTotals$`Raw OBPM`*playerSeasonTotals$`% of Min`, .before = '% of Min') 



Sum_o <- sum(playerSeasonTotals$Contrib, na.rm = TRUE)
Tm_Adj_o <- (AdjOffRating-Sum_o)/5
totals <- rbind(totals, playerSeasonTotals)

#Finish Calculations on Separate Dataframe

BPM <- data.frame(
             playerSeasonTotals$Name, 
             playerSeasonTotals$Team,
             playerSeasonTotals$Position, 
             playerSeasonTotals$`Offensive Role`, 
             playerSeasonTotals$MIN, 
             playerSeasonTotals$MIN/playerSeasonTotals$GP,
             playerSeasonTotals$`Raw BPM`+Tm_Adj,
             playerSeasonTotals$`Raw OBPM`+Tm_Adj_o)

BPM <- add_column(BPM, "DBPM" = BPM$playerSeasonTotals..Raw.BPM....Tm_Adj - BPM$playerSeasonTotals..Raw.OBPM....Tm_Adj_o)
BPM <- add_column(BPM, "Contribution" = BPM$playerSeasonTotals..Raw.BPM....Tm_Adj*playerSeasonTotals$`% of Min`)
BPM <- add_column(BPM, "VORP" = (BPM$playerSeasonTotals..Raw.BPM....Tm_Adj + 2)*playerSeasonTotals$`% of Min`*TeamGames/20)
BPM <- add_column(BPM, "eFG" = (playerSeasonTotals$FGM+(0.5*playerSeasonTotals$`3PM`))*100/playerSeasonTotals$FGA)
BPM <- add_column(BPM, "TOV" = ((playerSeasonTotals$TOV*100)/(playerSeasonTotals$TOV+(0.44*playerSeasonTotals$FTA)+playerSeasonTotals$FGA)))
BPM <- add_column(BPM, "FTF" = (playerSeasonTotals$FTM*100/playerSeasonTotals$FGA))
BPM <- add_column(BPM, "PPP" = round(playerSeasonTotals$PTS/playerSeasonTotals$Possessions*5,3))

colnames(BPM)[c(1:9)] <- c("Name", "Team", "Position", "Offensive_Role", "Minutes", "MPG", "BPM", "OBPM", "DBPM")

BPM <- cbind(BPM$Name, BPM$Team, round(BPM[c(3:14)],1), BPM$PPP)

colnames(BPM)[c(1,2,15)] <- c("Name", "Team", "PPP")


league <- rbind(league, BPM)
}


## Complete PER Calculation, uses possession estimator instead of actual possessions

qualifiedPlayers <- league
qualifiedTotals <- totals

lgPace <- (lgPoss * 5) / lgMin

lgVOP <- lgPTS / (lgFGA - lgORB + lgTO + (0.44*lgFTA))
lgDRBP <- (lgTRB - lgORB) / lgTRB
lgFactor <- ((2/3) - ((0.5* (lgAST/lgFG))/(2*(lgFG/lgFT))))

lguPER <- (1/lgMin)*(lgThree+((2.0 * lgAST)/3.0)+((2-(lgFactor*(lgAST/lgFG)))*lgFG) + (0.5*lgFT*(2-(1.0/3.0)*(lgAST/lgFG))) - (lgVOP*lgTO) - (lgVOP*lgDRBP*(lgFGA - lgFG)) - (lgVOP*0.44*(0.44+(0.56*lgDRBP))*(lgFTA-lgFT))+(lgVOP*(1-lgDRBP)*(lgTRB-lgORB))+(lgVOP*lgDRBP*lgORB)+(lgVOP*lgSTL)+(lgVOP*lgDRBP*lgBLK)-(lgPF*((lgFT/lgPF)-0.44*(lgFTA/lgPF)*lgVOP)))


PERlist <- vector()
colnames(TeamStats) <- c("Team", "GP", "MIN", "PTS", "FG", "FGA", "FG%", "X3FG", "X3FGA", "X3FG%", "FT", "FTA", "FT%", "OFF", "DEF", "TOT", "A", "STL", "BLK", "TO", "PF", "POSS", "oppPOSS", "Pace")
TeamStats <- TeamStats %>% mutate_at(c(2:24), as.numeric)
for (l in 1:length(qualifiedPlayers$Name)) {

  uPER <-  (1/qualifiedTotals$MIN[l])*(qualifiedTotals$`3PM`[l]+((2.0 * qualifiedTotals$AST[l])/3.0)
    +((2-(lgFactor*((TeamStats$A[which(qualifiedPlayers$Team[l] == TeamStats$Team)])/(TeamStats$FG[which(qualifiedPlayers$Team[l] == TeamStats$Team)]))))*qualifiedTotals$FGM[l]) + (0.5*qualifiedTotals$FTM[l]*(2-(1.0/3.0)*((TeamStats$A[which(qualifiedPlayers$Team[l] == TeamStats$Team)])/(TeamStats$FG[which(qualifiedPlayers$Team[l] == TeamStats$Team)]))))
    - (lgVOP*qualifiedTotals$TOV[l]) - (lgVOP*lgDRBP*(qualifiedTotals$FGA[l] - qualifiedTotals$FGM[l])) 
    - (lgVOP*0.44*(0.44+(0.56*lgDRBP))*(qualifiedTotals$FTA[l]-qualifiedTotals$FTM[l]))
    +(lgVOP*(1-lgDRBP)*(qualifiedTotals$TRB[l]-qualifiedTotals$OFF[l]))
    +(lgVOP*lgDRBP*qualifiedTotals$OFF[l])+(lgVOP*qualifiedTotals$STL[l])
    +(lgVOP*lgDRBP*qualifiedTotals$BLK[l])
    -(qualifiedTotals$PF[l]*((lgFT/lgPF)-0.44*(lgFTA/lgPF)*lgVOP)))
  
  PER <- round((uPER * (lgPace/TeamStats$Pace[which(qualifiedPlayers$Team[l] == TeamStats$Team)]))*(15/lguPER),1)
  
  PERlist <- append(PERlist, PER)
  
}
qualifiedPlayers <- add_column(qualifiedPlayers, "PER" = PERlist)

qualifiedPlayers <- qualifiedPlayers[order(qualifiedPlayers$VORP, decreasing = TRUE),]
rownames(qualifiedPlayers) <- NULL
kable(qualifiedPlayers[1:10,], caption = paste0("Individual Advanced Player Metrics for the Top 20 CEBL Players During the ", yr, " Season, Ordered by VORP"))
options(warn = oldw)
```
